<!doctype html>
<!--
Copyright 2018 The Go Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<html>

<head>
    <meta charset="utf-8">
    <title>0Chain WebSDK Demo</title>
</head>

<body>
    <script src="wasm_exec.js"></script>

    <table border="0" cellspacing="0" cellpadding="5">
        <tr>
            <td>Allocation Id : <input type="" name="allocationId" id="alloc_input" size=64
                    value="60e9471303e24e733ee0dd1b9f9a410f006783f4745248f4d26dac2a6cb90d0c"></td>
            <td><button onClick="createInstance()" id="instButton">Create Allocation</button></td>
        </tr>
        <tr>
            <!-- <td>Upload from (LocalPath) <input type="" name="uploadLocalPath" id="upload_local_path"></td> -->
            <td>Upload to (RemotePath) <input type="" name="uploadRemotePath" id="upload_remote_path"></td>
            <!-- <td><button onClick="Upload()" id="uploadButton">Upload</button></td> -->
            <td><input type="file" name="uploadFile" onchange="onFileChange(this)" /></td>
        </tr>
        <tr>
            <td>Download from (Remote Path) <input type="" name="downloadRemotePath" id="download_remote_path"></td>
            <td>Download to (Local Path) <input type="" name="localPath" id="local_path"></td>
            <td><button onClick="Download()" id="downloadButton">Download</button></td>
        </tr>
        <tr>
            <td><button onClick="SaveConfig()" id="saveConfig">SaveConfig</button></td>
            <td><button onClick="OnUnload()" id="releaseButton">Unload</button></td>
        </tr>
    </table>


    <script>

        const go = new Go();

        WebAssembly.instantiateStreaming(fetch("0chainsdk.wasm"), go.importObject).then(async (result) => {
            inst = result.instance;
            await go.run(inst)
        });

        // Client config
        const clientStr =
            `{
                "id" : "8cd930c50b8e06d9ba2ab6a86ca9e3c6d073974d6976312f36a766a7443efd55",
                "public_key" : "78d4cd4d6edbfb3f0a1c7dec479d5b295b9abc2c1d2d332e67a115a62a3c1fd0",
                "private_key" : "c8e05e590c3beddf0c2a239d04a92c20323e660d92e9d2a096e46577f4595b1478d4cd4d6edbfb3f0a1c7dec479d5b295b9abc2c1d2d332e67a115a62a3c1fd0"
            }`

        // Blobbers
        const blobberStr =
            `[
            {"id":"ccde4b06d02e24113889164d94a9692284f60c8701f10e600bde58889d335055","url":"http://localhost:5051"},
            {"id":"f45305566d865b06ff045e877d6daa76425ee04c84053d35aa462c4962351f45","url":"http://localhost:5052"},
            {"id":"73c154fc8347296880da8eaa9a8ad428d43196b438ceb28e64de1e19724e7e20","url":"http://localhost:5053"}
            ]`

        function createInstCb(err, msg) {
            console.log("Instance callback: " + err + "," + msg);
        }

        async function createInstance() {
            console.log("Creating instance...");
            ZcnCreateInstance(document.getElementById("alloc_input").value);
            ZcnSetConfig(clientStr, "", blobberStr, 2, 1, "createInstCb");
        }

        function OnUnload() {
            ZcnUnload();
        }

        function commitCb(err, msg) {
            console.log("Commit complete:" + err + "," + msg);
        }

        async function commit() {
            ZcnCommit("commitCb");
        }

        function uploadDownloadCb(status, op, err, filepath, numBytes, msg) {
            if (op === 0) {
                str = "Upload";
            } else {
                str = "Download";
            }
            if (err) {
                console.log(str + " failed " + filepath + err + msg);
            } else {
                if (status === 0) {
                    console.log(str + " started with total bytes " + numBytes);
                } else if (status === 1) {
                    console.log(str + " in progress... " + numBytes);
                } else if (status === 2) {
                    console.log(str + " Completed");
                    if (op === 0) {
                        commit();
                    }
                }
            }
        }

        async function Upload() {
            ZcnUploadFile(document.getElementById("upload_local_path").value, document.getElementById("upload_remote_path").value, "uploadDownloadCb");
        }
        async function onFileChange(currentTarget) {
            ZcnUploadFile(currentTarget.files[0].path, document.getElementById("upload_remote_path").value, "uploadDownloadCb");
        }

        async function Download() {
            ZcnDownloadFile(document.getElementById("download_remote_path").value, document.getElementById("local_path").value, "uploadDownloadCb");
        }

        function getBlobbersCb(status, config) {
            console.log(status + config);
        }

        function getDirTreeCb(status, config) {
            console.log(status + config);
        }

        function SaveConfig() {
            ZcnGetBlobbers("getBlobbersCb");
            ZcnGetDirTree("getDirTreeCb");
        }

    </script>

</body>

</html>