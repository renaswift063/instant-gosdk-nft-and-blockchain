name: gosdk

# on:
#   workflow_dispatch:
#     inputs:
#       fixed_tag:
#         description: 'type yes for building with tag v0.0.0'
#         default: 'no'
#         required: true

# env:
#   GOSDK_REGISTRY: gosdk/gosdk

on:
   push:
     branches: [ gitactionsfix ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    steps:

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.13

    # - name: Get the version
    #   id: get_version
    #   run: |
    #       BRANCH=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')
    #       SHORT_SHA=$(echo $GITHUB_SHA | head -c 8)
    #       echo ::set-output name=BRANCH::${BRANCH}
    #       echo ::set-output name=VERSION::${BRANCH}-${SHORT_SHA}

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      run: |
        go get -v -t -d ./...
        if [ -f Gopkg.toml ]; then
            curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
            dep ensure
        fi
    - name: Build
      run: go build -v ./...

    - name: Test
      run: go test -v ./...

  make:
    name: make-file
    runs-on: ubuntu-20.04
    needs: 
    - build
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Create sdkfile
      run: |
        cat <<EOF > sdkversion.go
          package main
            import (
                "fmt"
                "github.com/0chain/gosdk/zcncore"
            )
            func main() {
                fmt.Println("gosdk version: ", zcncore.GetVersion())
            }
        EOF
    - name: Create SDK
      run: go build -o sdkversion sdkversion.go
      
    - name: Build project
      run: |
        zip -r test.zip .  
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: 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
      with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          
    - name: Upload Release Asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: 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
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
        asset_path: ./my-artifact.zip
        asset_name: my-artifact.zip
        asset_content_type: application/zip
      
  #  - name: Push Build
  #    run: |
  #      if [[ "$FIXED_PUSH" == "yes" ]]; then
  #        push $GOSDK_REGISTRY:v0.0.0
  #      else
  #        push $GOSDK_REGISTRY:$TAG
  #      fi
  #    env:
  #      FIXED_PUSH: ${{ github.event.inputs.fixed_tag }}
  #      TAG: ${{ steps.get_version.outputs.VERSION }}
